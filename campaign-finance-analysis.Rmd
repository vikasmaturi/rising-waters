---
title: "Campaign-finance-analysis"
author: "Vikas Maturi"
output: 
  github_document:
    toc: true
    toc_depth: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraies

```{r}
#load libraries
library(tidyverse)
```

CHANGE THIS TO THE LOCATION OF THE SAVED .RDS FILE ON YOUR COMPUTER!
```{r}
#save the file name where the .Rds data is stored - 
LA_contributions_file <- "~/Autumn-2019/COMM177b/LA-contributions.Rds"

lobbying_file <- "~/Autumn-2019/COMM177b/lobbying_data.Rds"
```


#ONE TIME ONLY; READ IN FILES AND SAVE COMBINED DATA TO RDS
```{r, eval = FALSE}
#save data file names

file_LA_contributions_101012_020913 <- "~/Autumn-2019/COMM177b/LA_contributions_101012_020913.csv"
file_LA_contributions_021013_060913 <- "~/Autumn-2019/COMM177b/LA_contributions_021013_060913.csv"
file_LA_contributions_061013_100913 <- "~/Autumn-2019/COMM177b/LA_contributions_061013_100913.csv"
file_LA_contributions_101013_020914 <- "~/Autumn-2019/COMM177b/LA_contributions_101013_020914.csv"
file_LA_contributions_021014_060914 <- "~/Autumn-2019/COMM177b/LA_contributions_021014_060914.csv"
file_LA_contributions_061014_100914 <- "~/Autumn-2019/COMM177b/LA_contributions_061014_100914.csv"
file_LA_contributions_101014_020915 <- "~/Autumn-2019/COMM177b/LA_contributions_101014_020915.csv"
file_LA_contributions_021015_060915 <- "~/Autumn-2019/COMM177b/LA_contributions_021015_060915.csv"
file_LA_contributions_061015_100915 <- "~/Autumn-2019/COMM177b/LA_contributions_061018_100918.csv"
file_LA_contributions_101015_020916 <- "~/Autumn-2019/COMM177b/LA_contributions_101015_020916.csv"
file_LA_contributions_021016_060916 <- "~/Autumn-2019/COMM177b/LA_contributions_021016_060916.csv"
file_LA_contributions_061016_100916 <- "~/Autumn-2019/COMM177b/LA_contributions_061016_100916.csv"
file_LA_contributions_101016_020917 <- "~/Autumn-2019/COMM177b/LA_contributions_101016_020917.csv"
file_LA_contributions_021017_060917 <- "~/Autumn-2019/COMM177b/LA_contributions_021017_060917.csv"
file_LA_contributions_061017_100917 <- "~/Autumn-2019/COMM177b/LA_contributions_061017_100917.csv"

file_LA_contributions_101017_020918 <- "~/Autumn-2019/COMM177b/LA_contributions_101017_020918.csv"
file_LA_contributions_021018_060918 <- "~/Autumn-2019/COMM177b/LA_contributions_021018_060918.csv"
file_LA_contributions_061018_100918 <- "~/Autumn-2019/COMM177b/LA_contributions_061018_100918.csv"
file_LA_contributions_101018_020919 <- "~/Autumn-2019/COMM177b/LA_contributions_101018_020919.csv"
file_LA_contributions_021019_060919 <- "~/Autumn-2019/COMM177b/LA_contributions_021019_060919.csv"
file_LA_contributions_061019_101019 <- "~/Autumn-2019/COMM177b/LA_contributions_061019-101019.csv"

#save path to save file 
file_save_combined_path <- "~/Autumn-2019/COMM177b/LA-contributions.Rds"
```

```{r, eval = FALSE}

LA_contributions_101012_020913 <- read_csv(file_LA_contributions_101012_020913)
LA_contributions_021013_060913 <- read_csv(file_LA_contributions_021013_060913)
LA_contributions_061013_100913 <- read_csv(file_LA_contributions_061013_100913)
LA_contributions_101013_020914 <- read_csv(file_LA_contributions_101013_020914)
LA_contributions_021014_060914 <- read_csv(file_LA_contributions_021014_060914)
LA_contributions_061014_100914 <- read_csv(file_LA_contributions_061014_100914) 
LA_contributions_101014_020915 <- read_csv(file_LA_contributions_101014_020915) 
LA_contributions_021015_060915 <- read_csv(file_LA_contributions_021015_060915) 
LA_contributions_061015_100915 <- read_csv(file_LA_contributions_061015_100915) 
LA_contributions_101015_020916 <- read_csv(file_LA_contributions_101015_020916) 
LA_contributions_021016_060916 <- read_csv(file_LA_contributions_021016_060916) 
LA_contributions_061016_100916 <- read_csv(file_LA_contributions_061016_100916) 
LA_contributions_101016_020917 <- read_csv(file_LA_contributions_101016_020917) 
LA_contributions_021017_060917 <- read_csv(file_LA_contributions_021017_060917) 
LA_contributions_061017_100917 <- read_csv(file_LA_contributions_061017_100917)

#read files into tibbles (data frames)
LA_contributions_101017_020918 <- read_csv(file_LA_contributions_101017_020918)
LA_contributions_021018_060918 <- read_csv(file_LA_contributions_021018_060918)
LA_contributions_061018_100918 <- read_csv(file_LA_contributions_061018_100918)
LA_contributions_101018_020919 <- read_csv(file_LA_contributions_101018_020919)
LA_contributions_021019_060919 <- read_csv(file_LA_contributions_021019_060919)
LA_contributions_061019_101019 <- read_csv(file_LA_contributions_061019_101019)
```

```{r, eval = FALSE}

#Join data frames into single tibble (dataframe)
LA_contributions <-
  LA_contributions_061019_101019 %>% 
  bind_rows(LA_contributions_021019_060919) %>% 
  bind_rows(LA_contributions_101018_020919) %>% 
  bind_rows(LA_contributions_061018_100918) %>% 
  bind_rows(LA_contributions_021018_060918) %>% 
  bind_rows(LA_contributions_101017_020918) %>% 
  bind_rows(LA_contributions_061017_100917) %>% 
  bind_rows(LA_contributions_021017_060917) %>% 
  bind_rows(LA_contributions_101016_020917) %>% 
  bind_rows(LA_contributions_061016_100916) %>% 
  bind_rows(LA_contributions_021016_060916) %>% 
  bind_rows(LA_contributions_101015_020916) %>% 
  bind_rows(LA_contributions_061015_100915) %>% 
  bind_rows(LA_contributions_021015_060915) %>% 
  bind_rows(LA_contributions_101014_020915) %>% 
  bind_rows(LA_contributions_061014_100914) %>% 
  bind_rows(LA_contributions_021014_060914) %>% 
  bind_rows(LA_contributions_101013_020914) %>% 
  bind_rows(LA_contributions_061013_100913) %>% 
  bind_rows(LA_contributions_021013_060913) %>% 
  bind_rows(LA_contributions_101012_020913) 

```

```{r, eval = FALSE}

#Write combined data file out output .Rds file
#write_rds(LA_contributions, LA_contributions_file)
```

```{r, eval = FALSE}
lobbying_csv_file <- "~/Autumn-2019/COMM177b/CurrentCompanies.csv"

lobbying_csv <- read_csv(lobbying_csv_file)

write_rds(lobbying_csv, "~/Autumn-2019/COMM177b/lobbying_data.Rds")

```


# Read in .Rds data file will all campaign finance data
```{r}
LA_contributions <- 
  read_rds(LA_contributions_file) %>% 
  mutate(ContributionAmt = str_replace(ContributionAmt, "\\$", "")) %>% 
  mutate(ContributionAmt = as.numeric(ContributionAmt))

lobbying <- 
  read_rds(lobbying_file)
```

# Understand Report Types (to do)
```{r}
LA_contributions %>% select(ReportType) %>% group_by(ReportType) %>% count() %>% arrange(desc(n)) %>% head(10)
```

Some notes:
I can't figure out what ReportType (no idea) and ReportCode (starting with F1 is an individual and F2 is a PAC).

#TEMPORARILY manually inputting suspicion vendors
```{r}
vendors <-
  tribble(
    ~contractor,
    "LAFITTE AREA INDEPENDENT LEVEE DIST",
    "US DEPARTMENT OF AGRICLUTURE", 
    "US DEPARTMENT OF AGRICLUTURE",
    "GEC INC",
    "AECOM TECHNICAL SERVICES INC",
    "AECOM",
    "STANTON CONSTRUCTABILITY SVCS LLC",
    "STANTEC CONSULTING SERVICES INC",
    "GEC",
    "GHD INC",
    "THE LOUISIANA DIVERSION COMPANY JV"
  )
```

#trying to develop search function for data - not successful
```{r}
#test set of contributions
small_contributions <- 
  LA_contributions %>% 
  filter(str_detect(ContributorName, "DONALD T BOLLINGER|AECOM")) %>% 
  head(50) 
```
```{r}
# #function to check each Contributor Name against pre-defined vector 
# to_keep <- function(text, fixed_string) {
#   str_detect(text, fixed(fixed_string, ignore_case = TRUE))
# }
# 
# conts_keep <- map(LA_contributions$ContributorName, to_keep, vendors)
# 
# vec <- vector()
# 
# for(i in conts_keep){
#   x = i %>% some(isTRUE)
#   vec = append(vec, x)
#   #bind_rows(has_string, x)
# }
# 
# contains_vendor <- tibble(
#   has_vendor = vec
# )
# 
# LA_contributions %>% bind_cols(contains_vendor)

```

```{r}





test <- c("DONALD", "saa", "ASDafasdf")

x <- dd[[1]]

company_donations <-
  filter(test %>% map(~ to_keep(.x, text = ContributorName)) %>% pmap_lgl(all))


keep(dd[[1]], is.na)


map(dd, every(.p = is.logical))
lmap(dd) %>% lmap(is.na)




dd %>% map("d") %>% map_df(bind_rows)

y <- list(0:10, 5.5)
y %>% every(is.numeric)

every(dd[[1]], is.logical)



small_contributions %>% 
  mutate = 
  

 
company_donations %>% filter(str_detect(ContributorName, "STANTEC"))





```

```{r}
to_keep <- function(fixed_string, text) {
  !stringr::str_detect(text, stringr::fixed(fixed_string, ignore_case = TRUE))
}
to_keep("g", "g")

# create a vector of string to detect and to ignore
ignored_string <- c("squat when #Putin annexed Crimea", "environmental pol")

# dummy table
df <- tibble::tibble(
  text = c(ignored_string, "dummy")
)

df2 <- df %>% 
  dplyr::filter(
    ignored_string %>%
      # apply the filter of all the text rows for each pattern
      # you'll get one list of logical by pattern ignored_string
      purrr::map(~ to_keep(.x, text = text)) %>%
      # get a logical vector of rows to keep
      purrr::pmap_lgl(all)
  )
```


# Search contributors for contractors
```{r}
contractor_contributors <-
  LA_contributions %>% 
  filter(str_detect(ContributorName, "STANTEC|STANTON CONSTRUCTABILITY|AECOM|GEC INC|GHD INC|LOUISIANA DIVERSION COMPANY|LAFITTE AREA|MOTT MACDONALD|NOLA PAC|NOLA ENGINEERING|WEEKS MARINE|SOIL EROSION SERVICES|PROFESSIONAL CONSTRUCTION SERVICES|SIMON AND DELANEY RESOURCE|COASTAL DREDGING COMPANY|SOIL EROSION|GRILLOT CONSTRUCTION|SEALEVEL CONSTRUCTION|HYDROTERRA TECHNOLOGIES|WILCO MARSH BUGGIES|MITCH'S LANDSCAPING|MITCHS LANDSCAPING|LUHR BRO|BAIRD & ASSOCIATES|JUSTIN REEVES|JUSTIN J REEVES|BERTUCCI CONTRACTING|C&C TECHNOLOGIES|APOLLO ENVIRONMENTAL STRATEGIES|TETRA TECH|HDR ENGINEERING|ROYAL ENGINEERING|ECOLOGICAL RESTORATION SERVICES|GREAT LAKES DREDGE|MAGNOLIA DREDGE|EARTHBALANCE")) %>% 
  arrange(desc(ContributorName)) %>% 
  select(ContributorName, everything()) 
  
contractor_contributors

```

```{r}
total_giving_contractor <-
  contractor_contributors %>% 
  group_by(ContributorName) %>% 
  summarize(total_giving = sum(ContributionAmt, na.rm = TRUE)) %>% 
  arrange(desc(total_giving))

#write_csv(total_giving_contractor, "~/Autumn-2019/COMM177b/total_contractor_giving.csv")
```


```{r}
LA_contributions %>% 
  group_by(ContributorName) %>% 
  summarize(total_cont = sum(ContributionAmt)) %>% 
  arrange(desc(total_cont))
```

#Search lobbying database for contract companies
```{r}
contractor_lobbyists <-
  lobbying %>% 
  #this filter is copied directly from the campaign contribution search from above - should be continually copied for consistency.
  filter(str_detect(Rep_Name, "STANTEC|STANTON CONSTRUCTABILITY|AECOM|GEC INC|GHD INC|LOUISIANA DIVERSION COMPANY|LAFITTE AREA|MOTT MACDONALD|NOLA PAC|NOLA ENGINEERING|WEEKS MARINE|SOIL EROSION SERVICES|PROFESSIONAL CONSTRUCTION SERVICES|SIMON AND DELANEY RESOURCE|COASTAL DREDGING COMPANY|SOIL EROSION|GRILLOT CONSTRUCTION|SEALEVEL CONSTRUCTION|HYDROTERRA TECHNOLOGIES|WILCO MARSH BUGGIES|MITCH'S LANDSCAPING|MITCHS LANDSCAPING|LUHR BRO|BAIRD & ASSOCIATES|JUSTIN REEVES|JUSTIN J REEVES|BERTUCCI CONTRACTING|C&C TECHNOLOGIES|APOLLO ENVIRONMENTAL STRATEGIES|TETRA TECH|HDR ENGINEERING|ROYAL ENGINEERING|ECOLOGICAL RESTORATION SERVICES|GREAT LAKES DREDGE|MAGNOLIA DREDGE|EARTHBALANCE")) %>% 
  arrange(desc(Rep_Name)) %>% 
  select(Rep_Name, everything()) 

write_csv(contractor_lobbyists, "~/Autumn-2019/COMM177b/contractor_lobbying.csv")

```


